name: AutoVersionBump

on:
  workflow_dispatch:  # Đây là sự kiện để kích hoạt quy trình
    inputs:
      my_input:
        description: A custom input
        required: false
        default: "default_value"

jobs:
  version_bump:
    runs-on: ubuntu-latest
    env:
     BRANCH_NAME: dev
    steps:
    - name: Print Input
      run: |
        echo "Input: ${{ github.event.inputs.my_input }}"
        
    - name: Checkout branch
      uses: actions/checkout@v3
      with:
        ref: ${{ env.BRANCH_NAME }}

    - name: Githublog
      id: extract_version
      uses: actions/github-script@v5
      with:
        script: |
          const log = ${{ toJSON(github) }};
          console.log(log);
    - name: Github object
      uses: actions/github-script@v5
      with:
        script: |
          console.log(github);    
          
    - name: project file detail
      uses: actions/github-script@v5
      with:
        script: |
          const fs = require('fs');
          const path = 'SPRNetTool/SPRNetTool.csproj';  // Thay đổi đường dẫn tương ứng
          const versionRegex = /<Version>(.*?)<\/Version>/;
          // Đọc nội dung của tệp .csproj
          let csprojContent = fs.readFileSync(path, 'utf8');
          console.log(csprojContent);
          
    - name: Build
      run: |
          echo "Building the code..."
    - name: Get last commit message
      shell: bash
      run: |
        response=$(curl -L \
        -H "Accept: application/vnd.github+json" \
        -H "Authorization: Bearer  ${{ secrets.GITHUB_TOKEN }}" \
        -H "X-GitHub-Api-Version: 2022-11-28" \
        https://api.github.com/repos/${{ github.repository }}/commits/${{ env.BRANCH_NAME }})
        commit_message=$(echo "$response" | jq -r '.commit.message')
        # In commit message
        echo "Commit Message: $commit_message"
        echo "LAST_COMMIT_MESSAGE=$commit_message" >> $GITHUB_ENV
        
    - name: Get last commit message
      id: last_commit
      uses: actions/github-script@v4
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          console.log(context.repo)
          const { data: commits } = await github.repos.listCommits({
            owner: context.repo.owner,
            repo: context.repo.repo,
            ref: 'dev',
            per_page: 1
          });
          const commitMessage = commits[0].commit.message;
          console.log(commitMessage);
          console.log(process.env.LAST_COMMIT_MESSAGE);
          
    - uses: actions/setup-node@v3
      with:
          node-version: 16
    - run: npm install xml2js
    - name: Run JavaScript script
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const xml2js = require('xml2js');
          const xmlString = `<PropertyGroup>
              <OutputType>WinExe</OutputType>
              <TargetFramework>net6.0-windows</TargetFramework>
              <Nullable>enable</Nullable>
              <UseWPF>true</UseWPF>
              <AllowUnsafeBlocks>True</AllowUnsafeBlocks>
              <UseWindowsForms>True</UseWindowsForms>
              <AssemblyVersion>1.0.0.1</AssemblyVersion>
              <FileVersion>1.0.0.1</FileVersion>
              <Version>1.0.0.1</Version>
          </PropertyGroup>`;

          // Phân tích XML thành đối tượng JavaScript
          xml2js.parseString(xmlString, (err, result) => {
              if (err) {
                  console.error(err);
                  return;
              }

              // Truy cập các phần tử trong đối tượng JavaScript
              const propertyGroup = result.PropertyGroup;
              console.log(propertyGroup.OutputType[0]); // WinExe
              console.log(propertyGroup.TargetFramework[0]); // net6.0-windows
              // ...

              // Chuyển đối tượng JavaScript thành JSON
              const jsonResult = JSON.stringify(result);
              console.log(jsonResult);
          })
